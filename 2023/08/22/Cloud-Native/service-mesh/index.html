<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta name="google-site-verification" content="lk2gSYFP_NyLNFob-fFnt7fm-I_n1ZYws-WZll7mshg">
  <meta name="msvalidate.01" content="6Jdc01DjYOLguhS5">
  <meta name="baidu-site-verification" content="code-NR10G09zww">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7Ccursive:300,300italic,400,400italic,700,700italic%7CSource+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/yellow/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fresh88888888.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/local-search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":true}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/config.min.js"></script>

    <meta name="description" content="微服务架构的特性  围绕业务构建团队">
<meta property="og:type" content="article">
<meta property="og:title" content="Service Mesh 架构">
<meta property="og:url" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/index.html">
<meta property="og:site_name" content="UMBRELLA">
<meta property="og:description" content="微服务架构的特性  围绕业务构建团队">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_1.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_2.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_3.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_4.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_5.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_6.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_7.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_8.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_9.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_10.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_11.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_12.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_13.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_14.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_15.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_18.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_31.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_32.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_22.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_23.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_21.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_24.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_25.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_26.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_27.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_28.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_29.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_30.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_33.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_34.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_35.png">
<meta property="og:image" content="https://fluxcd.io/">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_36.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_37.png">
<meta property="og:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_38.png">
<meta property="article:published_time" content="2023-08-22T02:23:01.000Z">
<meta property="article:modified_time" content="2023-08-22T02:23:01.000Z">
<meta property="article:author" content="umbrella">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="service mesh">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/service_mesh_1.png">


<link rel="canonical" href="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/","path":"2023/08/22/Cloud-Native/service-mesh/","title":"Service Mesh 架构"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Service Mesh 架构 | UMBRELLA</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">UMBRELLA</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">未雨绸缪，举重若轻</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-算法"><a href="/Algorithm/" rel="section"><i class="fa fa-calendar fa-fw"></i>算法</a></li><li class="menu-item menu-item-c++-&nbsp;编程"><a href="/Programming-C++/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>C++ &nbsp;编程</a></li><li class="menu-item menu-item-rust-编程"><a href="/Programming-Rust/" rel="section"><i class="fa fa-cat fa-fw"></i>Rust 编程</a></li><li class="menu-item menu-item-go-&nbsp;&nbsp;&nbsp;编程"><a href="/Programming-Go/" rel="section"><i class="fa fa-hippo fa-fw"></i>Go &nbsp;&nbsp;&nbsp;编程</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E6%BC%94%E8%BF%9B"><span class="nav-number">1.</span> <span class="nav-text">Service Mesh 演进</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E5%AE%9A%E4%B9%89"><span class="nav-number">2.</span> <span class="nav-text">Service Mesh 定义</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E4%BA%A7%E5%93%81%E5%BD%A2%E6%80%81"><span class="nav-number">3.</span> <span class="nav-text">Service Mesh 产品形态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">4.</span> <span class="nav-text">Service Mesh 主要功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E4%B8%8E-Kubernetes%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">5.</span> <span class="nav-text">Service Mesh 与 Kubernetes的关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh-%E4%B8%8E-API%E7%BD%91%E5%85%B3%E7%9A%84%E5%BC%82%E5%90%8C%E7%82%B9"><span class="nav-number">6.</span> <span class="nav-text">Service Mesh 与 API网关的异同点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Service-Mesh%E4%BA%A7%E5%93%81%E5%8F%91%E5%B1%95%E5%8F%B2"><span class="nav-number">7.</span> <span class="nav-text">Service Mesh产品发展史</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Istio-%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E8%83%BD%E5%8A%9B"><span class="nav-number">8.</span> <span class="nav-text">Istio 的流量控制能力</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90"><span class="nav-number">8.1.</span> <span class="nav-text">核心资源</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1"><span class="nav-number">8.2.</span> <span class="nav-text">虚拟服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E8%A7%84%E5%88%99"><span class="nav-number">8.3.</span> <span class="nav-text">目标规则</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BD%91%E5%85%B3"><span class="nav-number">8.4.</span> <span class="nav-text">网关</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%85%A5%E5%8F%A3"><span class="nav-number">8.5.</span> <span class="nav-text">服务入口</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SideCar"><span class="nav-number">8.6.</span> <span class="nav-text">SideCar</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%BC%B9%E6%80%A7%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">8.7.</span> <span class="nav-text">网络弹性和测试</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="nav-number">9.</span> <span class="nav-text">可观测性</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%EF%BC%88Metrics%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">指标（Metrics）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%EF%BC%88Access-Logs%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">访问日志（Access Logs）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%EF%BC%88Distributed-tracing%EF%BC%89"><span class="nav-number">9.3.</span> <span class="nav-text">分布式追踪（Distributed tracing）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8"><span class="nav-number">10.</span> <span class="nav-text">网络安全</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-number">10.1.</span> <span class="nav-text">认证</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%88%E6%9D%83"><span class="nav-number">10.2.</span> <span class="nav-text">访问授权</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1%EF%BC%88SDS%EF%BC%89"><span class="nav-number">10.3.</span> <span class="nav-text">安全发现服务（SDS）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%8C%E5%90%91%E9%AA%8C%E8%AF%81-mTLS"><span class="nav-number">10.4.</span> <span class="nav-text">双向验证 (mTLS)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%8F%8A%E6%8E%88%E6%9D%83%EF%BC%88JWT%EF%BC%89"><span class="nav-number">10.5.</span> <span class="nav-text">身份认证及授权（JWT）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%8F%8A%E6%B5%8B%E8%AF%95"><span class="nav-number">11.</span> <span class="nav-text">调试及测试</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5"><span class="nav-number">11.1.</span> <span class="nav-text">故障注入</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%EF%BC%88Traffic-Mirroring%EF%BC%89"><span class="nav-number">11.2.</span> <span class="nav-text">流量镜像（Traffic Mirroring）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Istio-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="nav-number">12.</span> <span class="nav-text">Istio 安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85K8S"><span class="nav-number">12.1.</span> <span class="nav-text">安装K8S</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD-Istio"><span class="nav-number">12.2.</span> <span class="nav-text">下载 Istio</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Istio"><span class="nav-number">12.3.</span> <span class="nav-text">安装 Istio</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-bookinfo-%E5%BA%94%E7%94%A8"><span class="nav-number">12.4.</span> <span class="nav-text">部署 bookinfo 应用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%BB%AA%E8%A1%A8%E7%9B%98%EF%BC%88Dashboard%EF%BC%89"><span class="nav-number">12.5.</span> <span class="nav-text">查看仪表盘（Dashboard）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8D%B8%E8%BD%BD-Istio"><span class="nav-number">12.6.</span> <span class="nav-text">卸载 Istio</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Istio-%E9%81%A5%E6%B5%8B%EF%BC%88Telemetry%EF%BC%89"><span class="nav-number">13.</span> <span class="nav-text">Istio 遥测（Telemetry）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Istio-%E9%81%A5%E6%B5%8B%E6%8C%87%E6%A0%87"><span class="nav-number">13.1.</span> <span class="nav-text">Istio 遥测指标</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Istio-%E9%81%A5%E6%B5%8B%E6%9E%B6%E6%9E%84-v2"><span class="nav-number">13.2.</span> <span class="nav-text">Istio 遥测架构 v2</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WASM%E6%9E%B6%E6%9E%84"><span class="nav-number">13.3.</span> <span class="nav-text">WASM架构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Istio-%E7%9A%84%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">13.4.</span> <span class="nav-text">Istio 的安全机制</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Envoy-%E6%9E%B6%E6%9E%84"><span class="nav-number">14.</span> <span class="nav-text">Envoy 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Envoy-%E6%B5%81%E9%87%8F%E4%BA%94%E5%85%83%E7%BB%84"><span class="nav-number">14.1.</span> <span class="nav-text">Envoy 流量五元组</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Envoy-%E8%B0%83%E8%AF%95%E5%85%B3%E9%94%AE%E5%AD%97%E6%AE%B5%EF%BC%88RESPONSE-FLAG%EF%BC%89"><span class="nav-number">14.2.</span> <span class="nav-text">Envoy 调试关键字段（RESPONSE_FLAG）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA"><span class="nav-number">15.</span> <span class="nav-text">分布式追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Jaejer-%E7%BB%84%E4%BB%B6"><span class="nav-number">15.1.</span> <span class="nav-text">Jaejer 组件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Jaejer-%E6%9E%B6%E6%9E%84"><span class="nav-number">15.2.</span> <span class="nav-text">Jaejer 架构</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5"><span class="nav-number">16.</span> <span class="nav-text">项目实践</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E7%9A%84CI-CD%E8%BF%87%E7%A8%8B%EF%BC%88DevOps%EF%BC%89"><span class="nav-number">16.1.</span> <span class="nav-text">典型的CI&#x2F;CD过程（DevOps）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#GitOps-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90-%E4%BA%A4%E4%BB%98%E8%BF%87%E7%A8%8B"><span class="nav-number">16.2.</span> <span class="nav-text">GitOps 持续集成&#x2F;交付过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DevOps%EF%BC%88push-pipeline%EF%BC%89vs-GitOps%EF%BC%88pull-pipeline%EF%BC%89"><span class="nav-number">16.3.</span> <span class="nav-text">DevOps（push pipeline）vs GitOps（pull pipeline）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Flux-%E4%BB%8B%E7%BB%8D"><span class="nav-number">16.4.</span> <span class="nav-text">Flux 介绍</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Flagger-%E8%87%AA%E5%8A%A8%E5%8C%96%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83-%E9%87%91%E4%B8%9D%E9%9B%80%E9%83%A8%E7%BD%B2"><span class="nav-number">16.5.</span> <span class="nav-text">Flagger 自动化灰度发布(金丝雀部署)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%B9%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="nav-number">17.</span> <span class="nav-text">弹性设计</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="umbrella"
      src="/avatar.jpeg">
  <p class="site-author-name" itemprop="name">umbrella</p>
  <div class="site-description" itemprop="description">没事就多看看书</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fresh88888888" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fresh88888888" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fresh888888@foxmail.com" title="E-Mail → mailto:fresh888888@foxmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.rust-lang.org/zh-CN/" title="https:&#x2F;&#x2F;www.rust-lang.org&#x2F;zh-CN&#x2F;" rel="noopener" target="_blank">Rust</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://go.dev/" title="https:&#x2F;&#x2F;go.dev&#x2F;" rel="noopener" target="_blank">Golang</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://isocpp.org/" title="https:&#x2F;&#x2F;isocpp.org&#x2F;" rel="noopener" target="_blank">C++</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.python.org/" title="https:&#x2F;&#x2F;www.python.org&#x2F;" rel="noopener" target="_blank">Python</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://doc.rust-lang.org/cargo/index.html" title="https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;cargo&#x2F;index.html" rel="noopener" target="_blank">Cargo</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://gist.github.com/rxaviers/7360908" title="https:&#x2F;&#x2F;gist.github.com&#x2F;rxaviers&#x2F;7360908" rel="noopener" target="_blank">Emoji</a>
            </li>
        </ul>
      </div>
    </div>
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.jpeg">
      <meta itemprop="name" content="umbrella">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UMBRELLA">
      <meta itemprop="description" content="没事就多看看书">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Service Mesh 架构 | UMBRELLA">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Service Mesh 架构
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-22 10:23:01" itemprop="dateCreated datePublished" datetime="2023-08-22T10:23:01+08:00">2023-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Service-Mesh/" itemprop="url" rel="index"><span itemprop="name">Service Mesh</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>20 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>微服务架构的特性</p>
<ul>
<li>围绕业务构建团队<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_1.png" class="">
<span id="more"></span></li>
<li>去中心化的数据管理<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_2.png" class=""></li>
</ul>
<p>如何管理和控制服务间的通信</p>
<ul>
<li>服务注册和发现</li>
<li>路由，流量转移</li>
<li>弹性能力（熔断、超时、重试）</li>
<li>安全（身份认证、授权）</li>
<li>可观察性（可视化）</li>
</ul>
<h5 id="Service-Mesh-演进"><a href="#Service-Mesh-演进" class="headerlink" title="Service Mesh 演进"></a>Service Mesh 演进</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_3.png" class="">

<h5 id="Service-Mesh-定义"><a href="#Service-Mesh-定义" class="headerlink" title="Service Mesh 定义"></a>Service Mesh 定义</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_4.png" class="">

<h5 id="Service-Mesh-产品形态"><a href="#Service-Mesh-产品形态" class="headerlink" title="Service Mesh 产品形态"></a>Service Mesh 产品形态</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_5.png" class="">
<p><code>service mesh</code> 是<code>sidecar</code>的网络拓扑模式</p>
<h5 id="Service-Mesh-主要功能"><a href="#Service-Mesh-主要功能" class="headerlink" title="Service Mesh 主要功能"></a>Service Mesh 主要功能</h5><ul>
<li>流量控制：路由:（负载均衡、蓝绿部署、灰度发布、AB测试）、流量转移、超时重试、熔断、故障注入、流量镜像</li>
<li>策略：黑、白名单、流量限制</li>
<li>网络安全：授权、身份认证</li>
<li>可观测性：指标收集和展示、日志收集、分布式追踪</li>
</ul>
<h5 id="Service-Mesh-与-Kubernetes的关系"><a href="#Service-Mesh-与-Kubernetes的关系" class="headerlink" title="Service Mesh 与 Kubernetes的关系"></a>Service Mesh 与 Kubernetes的关系</h5><ul>
<li><p>kubernetes</p>
<ol>
<li>解决容器编排和调度的问题</li>
<li>本质上是管理应用的生命周期（调度器）</li>
<li>给予<code>service mesh</code> 支持和帮助</li>
</ol>
</li>
<li><p>service mesh</p>
<ol>
<li>解决服务间网络通信的问题</li>
<li>本质上是管理服务通信（代理）</li>
<li>是对<code>kubernetes</code>网络功能方面的扩展和延伸</li>
</ol>
</li>
</ul>
<h5 id="Service-Mesh-与-API网关的异同点"><a href="#Service-Mesh-与-API网关的异同点" class="headerlink" title="Service Mesh 与 API网关的异同点"></a>Service Mesh 与 API网关的异同点</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_6.png" class="asset_img">
<ul>
<li>功能有重叠，但角色不同</li>
<li><code>Service Mesh</code> 在应用内，API网关在应用之上（边界）</li>
</ul>
<h5 id="Service-Mesh产品发展史"><a href="#Service-Mesh产品发展史" class="headerlink" title="Service Mesh产品发展史"></a>Service Mesh产品发展史</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_7.png" class="">

<h5 id="Istio-的流量控制能力"><a href="#Istio-的流量控制能力" class="headerlink" title="Istio 的流量控制能力"></a>Istio 的流量控制能力</h5><ul>
<li>路由(负载均衡)、流量转移</li>
<li>流量进出</li>
<li>网络弹性能力（熔断、超时控制）</li>
<li>测试相关</li>
</ul>
<h6 id="核心资源"><a href="#核心资源" class="headerlink" title="核心资源"></a>核心资源</h6><ul>
<li>虚拟服务（<code>Virtual Service</code>）</li>
<li>目标规则（<code>Destination Rule</code>）</li>
<li>网关（<code>Gateway</code>）</li>
<li>服务入口（<code>Service Entry</code>）</li>
<li><code>SideCar</code></li>
</ul>
<h6 id="虚拟服务"><a href="#虚拟服务" class="headerlink" title="虚拟服务"></a>虚拟服务</h6><ul>
<li>将流量路由到给定目标地址</li>
<li>请求地址与真实的工作负载解耦</li>
<li>包含一组路由规则</li>
<li>通常和目标规则（<code>destnation rule</code>）成堆出现</li>
<li>丰富的路由匹配规则<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_8.png" class=""></li>
</ul>
<h6 id="目标规则"><a href="#目标规则" class="headerlink" title="目标规则"></a>目标规则</h6><ul>
<li>定义虚拟服务路由目标地址的真实地址，即子集（<code>subset</code>）</li>
<li>设置负载均衡的方式（随机、轮询、权重、最小请求数）<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_9.png" class=""></li>
</ul>
<h6 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h6><ul>
<li>管理进出网格的流量</li>
<li>处在网格的边界<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_10.png" class=""></li>
</ul>
<h6 id="服务入口"><a href="#服务入口" class="headerlink" title="服务入口"></a>服务入口</h6><ul>
<li>把外部服务注册到网格中</li>
<li>功能（为外部目标转发请求；添加超时重试等策略；扩展网格）<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_11.png" class=""></li>
</ul>
<h6 id="SideCar"><a href="#SideCar" class="headerlink" title="SideCar"></a>SideCar</h6><ul>
<li>调整<code>Envoy</code>代理接管的端口和协议</li>
<li>限制<code>Envoy</code>代理可访问的服务<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_12.png" class=""></li>
</ul>
<h6 id="网络弹性和测试"><a href="#网络弹性和测试" class="headerlink" title="网络弹性和测试"></a>网络弹性和测试</h6><ul>
<li>弹性能力：超时、重试、熔断</li>
<li>测试能力：故障注入、流量镜像</li>
</ul>
<h5 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h5><ul>
<li>从开发者的角度探究系统的运行状态</li>
<li>组成：指标、日志、追踪<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_13.png" class=""></li>
</ul>
<h6 id="指标（Metrics）"><a href="#指标（Metrics）" class="headerlink" title="指标（Metrics）"></a>指标（Metrics）</h6><ul>
<li>以聚合的方式监控和理解系统的行为</li>
<li><code>Istio</code>指标的分类（1.<strong>代理级别的指标</strong>,收集目标是<code>sidecar</code>代理，资源粒度上的网格监控，容许指定收集的代理，主要用于针对性的调试；2.<strong>服务级别的指标</strong>，用于监控服务通信，四个基本的服务监控需求是延迟、流量、错误、饱和，默认指标导出到<code>Prometheus</code>，并且可自定更改。可根据需求开启和关闭；3.<strong>控制平面指标</strong>，对自身组件行为的监控，用于了解网络的健康情况）</li>
</ul>
<h6 id="访问日志（Access-Logs）"><a href="#访问日志（Access-Logs）" class="headerlink" title="访问日志（Access Logs）"></a>访问日志（Access Logs）</h6><ul>
<li>通过应用产生的事件来了解系统</li>
<li>包括了完整的元数据信息（目标、源）</li>
<li>生成位置可选（本地，远端，如<code>filebeat</code>）</li>
<li>日志内容<ul>
<li>应用日志</li>
<li>Envoy日志</li>
</ul>
</li>
</ul>
<h6 id="分布式追踪（Distributed-tracing）"><a href="#分布式追踪（Distributed-tracing）" class="headerlink" title="分布式追踪（Distributed tracing）"></a>分布式追踪（Distributed tracing）</h6><ul>
<li>通过追踪请求，了解服务的调用关系</li>
<li>常用于调用链路的问题排查、性能分析</li>
<li>支持多种追踪系统（<code>jeager、Zipkin、DataDog</code>）</li>
</ul>
<h5 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h5><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_14.png" class="">

<ul>
<li>身份认证（authentication）：证书管理、证书认证，<code>You are who you say you are</code></li>
<li>访问授权（authoriztaion）：授权策略, <code>You can do what you want to do</code></li>
<li>验证（vaildation）：输入验证, <code>Input is correct</code></li>
</ul>
<h6 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h6><ul>
<li>认证方式<ul>
<li>对等认证：用于服务间身份认证。 <code>Mutual（mTLS）</code></li>
<li>请求认证：用于终端用户身份认证；<code>Json Web Token(JWT)</code></li>
</ul>
</li>
<li>认证策略<ul>
<li>配置方式：<code>yaml</code>配置文件</li>
<li>配置生效范围：网格-全网格生效、按命名空间生效、按服务（工作负载）生效</li>
<li>策略更新：</li>
</ul>
</li>
<li>支持兼容模式<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_15.png" class=""></li>
</ul>
<p>认证策略同步到数据面的方式为：<br>阶段一：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">对等认证-----设置mTLS----兼容模式</span><br><span class="line">                          </span><br><span class="line">                          </span><br><span class="line">                       严格模式</span><br><span class="line"></span><br><span class="line">                (新)jwt</span><br><span class="line">              /      \</span><br><span class="line">             /        \</span><br><span class="line">身份认证                 策略</span><br><span class="line">             \        /</span><br><span class="line">              \      /</span><br><span class="line">                (旧)jwt</span><br></pre></td></tr></table></figure>
<p>阶段二：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">对等认证-----设置mTLS----严格模式</span><br><span class="line">                          </span><br><span class="line">                          </span><br><span class="line">                       严格模式</span><br><span class="line"></span><br><span class="line">                (新)jwt</span><br><span class="line">            /      \</span><br><span class="line">           /        \</span><br><span class="line">身份认证                 策略</span><br><span class="line">           \         </span><br><span class="line">            \     </span><br><span class="line">                (旧)jwt</span><br></pre></td></tr></table></figure>

<h6 id="访问授权"><a href="#访问授权" class="headerlink" title="访问授权"></a>访问授权</h6><ul>
<li>授权级别</li>
<li>策略分发</li>
<li>授权引擎</li>
<li>无需显示启用<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_18.png" class=""></li>
</ul>
<p>大致分为三种方式：</p>
<ul>
<li>按网格授权</li>
<li>按命名空间授权</li>
<li>按服务（工作负载）授权</li>
</ul>
<p>授权策略：配置通过<code>AuthorizationPolicy</code>实现；组成部分：选择器（<code>selector</code>）;行为(<code>Action</code>); 规则列表(<code>Rules</code>)：来源（<code>from</code>）、操作(<code>to</code>)、匹配条件(<code>when</code>);范围设置：<code>metadata/namespace,selector</code>; 值匹配：精确、模糊、前缀、后缀；全部允许和拒绝；自定义条件。</p>
<h6 id="安全发现服务（SDS）"><a href="#安全发现服务（SDS）" class="headerlink" title="安全发现服务（SDS）"></a>安全发现服务（SDS）</h6><ul>
<li>身份和证书管理</li>
<li>实现安全配置自动化</li>
<li>中心化<code>SDS Server</code></li>
<li>优点：无需挂载secret卷；动态更新证书，无需重启；可监视多个证书密钥对<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_31.png" class=""></li>
</ul>
<h6 id="双向验证-mTLS"><a href="#双向验证-mTLS" class="headerlink" title="双向验证 (mTLS)"></a>双向验证 (mTLS)</h6><ul>
<li><code>TLS</code>：客户端根据服务端证书验证其身份</li>
<li><code>mTLS</code>：客户端、服务器端彼此都验证对方身份</li>
</ul>
<h6 id="身份认证及授权（JWT）"><a href="#身份认证及授权（JWT）" class="headerlink" title="身份认证及授权（JWT）"></a>身份认证及授权（JWT）</h6><ul>
<li><code>Json Web Token</code></li>
<li>以<code>json</code>格式传递信息</li>
<li>应用场景：授权和信息交换</li>
<li>组成部分：<code>Header、Payload、Signature</code><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_32.png" class=""></li>
</ul>
<h5 id="调试及测试"><a href="#调试及测试" class="headerlink" title="调试及测试"></a>调试及测试</h5><h6 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h6><ul>
<li><code>Netflix</code>的 <code>Chaos Monkey</code></li>
<li>混沌工程（<code>Chaos engineering</code>）<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_22.png" class="">
配置延迟故障<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_23.png" class=""></li>
</ul>
<h6 id="流量镜像（Traffic-Mirroring）"><a href="#流量镜像（Traffic-Mirroring）" class="headerlink" title="流量镜像（Traffic Mirroring）"></a>流量镜像（Traffic Mirroring）</h6><ul>
<li>实时复制请求到镜像服务</li>
<li>应用场景：1.线上问题排查(<code>troubleshooting</code>)；2.观察生产环境的请求处理能力(压力测试)；3.复制请求信息用于分析</li>
</ul>
<h5 id="Istio-安装部署"><a href="#Istio-安装部署" class="headerlink" title="Istio 安装部署"></a>Istio 安装部署</h5><ol>
<li>安装K8s</li>
<li>安装 <code>Istio</code></li>
<li>部署官方 <code>Demo</code> 体验 <code>Istio</code></li>
</ol>
<h6 id="安装K8S"><a href="#安装K8S" class="headerlink" title="安装K8S"></a>安装K8S</h6><p>请参见<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start/"><code>minikubte download</code></a> 略</p>
<h6 id="下载-Istio"><a href="#下载-Istio" class="headerlink" title="下载 Istio"></a>下载 Istio</h6><ul>
<li>在线下载：<code>curl -L https://istio.io/downloadIstio | sh -</code></li>
<li>离线下载：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://github.com/istio/istio/releases/download/1.18.2/istio-1.18.2-linux-amd64.tar.gz</span><br><span class="line">...</span><br><span class="line">tar -zxvf istio-1.18.2-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
压缩包里包含以下内容:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vela istio-1.18.1]<span class="comment"># ll</span></span><br><span class="line">drwxr-x---  2 root root    22 Jul 14 04:37 bin</span><br><span class="line">-rw-r--r--  1 root root 11348 Jul 14 04:37 LICENSE</span><br><span class="line">drwxr-xr-x  5 root root    52 Jul 14 04:37 manifests</span><br><span class="line">-rw-r-----  1 root root   986 Jul 14 04:37 manifest.yaml</span><br><span class="line">-rw-r--r--  1 root root  6595 Jul 14 04:37 README.md</span><br><span class="line">drwxr-xr-x 24 root root  4096 Jul 14 04:37 samples</span><br><span class="line">drwxr-xr-x  3 root root    57 Jul 14 04:37 tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>
各个目录的作用：</li>
<li><code>bin</code>：存放的是 <code>istioctl</code> 工具</li>
<li><code>manifests</code>：相关 <code>yaml</code> 用于部署 <code>Istio</code></li>
<li><code>samples</code>：一些 <code>Demo</code> 用的 <code>yaml</code></li>
<li><code>tools</code>：一些工具，暂时使用不到<br>先将<code>istioctl</code>工具 <code>cp</code> 到 <code>bin</code> 目录下，便于后续使用 <code>istioctl</code> 命令。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> bin/istioctl /usr/local/bin/</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="安装-Istio"><a href="#安装-Istio" class="headerlink" title="安装 Istio"></a>安装 Istio</h6><blockquote>
<p>由于易用性的问题，Istio 废弃了以前的 Helm 安装方式，现在使用 istioctl 即可一键安装。<br><code>Istio</code> 提供了以下配置档案（<code>configuration profile</code>）供不同场景使用，查看当前内置的 <code>profile</code>：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl profile list</span><br><span class="line">Istio configuration profiles:</span><br><span class="line">    default</span><br><span class="line">    demo</span><br><span class="line">    empty</span><br><span class="line">    external</span><br><span class="line">    minimal</span><br><span class="line">    openshift</span><br><span class="line">    preview</span><br><span class="line">    remote</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>具体每个 <code>profile</code> 包含哪些组件，可以使用<code>istioctl profile dump</code>命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl profile dump demo</span><br></pre></td></tr></table></figure>
<p>对于演示环境，我们直接安装 demo 版本就可以了 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl install --<span class="built_in">set</span> profile=demo -y</span><br><span class="line"></span><br><span class="line">✔ Istiod installed                                       </span><br><span class="line">✔ Ingress gateways installed                             </span><br><span class="line">✔ Egress gateways installed                             </span><br><span class="line">✔ Installation complete</span><br><span class="line">Making this installation the default <span class="keyword">for</span> injection and validation.</span><br></pre></td></tr></table></figure>
<p>部署完成后,这里k8s先需要创建一个命名空间, 然后给命名空间打上 label，告诉 Istio 在部署应用的时候，自动注入 Envoy 边车代理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create namspace `k8s-istio`</span><br><span class="line">...</span><br><span class="line">$ kubectl label namespace `k8s-istio` istio-injection=enabled</span><br></pre></td></tr></table></figure>
<p>安装后可以验证是否安装正确。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先根据安装的profile导出manifest</span></span><br><span class="line">istioctl manifest generate --<span class="built_in">set</span> profile=demo &gt; <span class="variable">$HOME</span>/generated-manifest.yaml</span><br><span class="line"><span class="comment"># 然后根据验证实际环境和manifest文件是否一致</span></span><br><span class="line">istioctl verify-install -f <span class="variable">$HOME</span>/generated-manifest.yaml</span><br><span class="line"><span class="comment"># 出现下面信息则表示验证通过</span></span><br><span class="line">✔ Istio is installed and verified successfully</span><br></pre></td></tr></table></figure>
<p>查看一下安装了些什么东西：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n istio-system</span><br><span class="line"></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-egressgateway-75db994b58-jlc28    1/1     Running   0          38m</span><br><span class="line">istio-ingressgateway-79bb75ddbb-dmm87   1/1     Running   0          38m</span><br><span class="line">istiod-68cb9f5cb6-h5fcv                 1/1     Running   0          39m</span><br></pre></td></tr></table></figure>
<p>可以看到只安装了出入站网关以及最重要的 Istiod 服务。再看下 CRD 情况:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get crds |grep istio</span><br><span class="line"></span><br><span class="line">authorizationpolicies.security.istio.io    2023-08-24T05:12:04Z</span><br><span class="line">destinationrules.networking.istio.io       2023-08-24T05:12:04Z</span><br><span class="line">envoyfilters.networking.istio.io           2023-08-24T05:12:04Z</span><br><span class="line">gateways.networking.istio.io               2023-08-24T05:12:04Z</span><br><span class="line">istiooperators.install.istio.io            2023-08-24T05:12:04Z</span><br><span class="line">peerauthentications.security.istio.io      2023-08-24T05:12:04Z</span><br><span class="line">proxyconfigs.networking.istio.io           2023-08-24T05:12:04Z</span><br><span class="line">requestauthentications.security.istio.io   2023-08-24T05:12:04Z</span><br><span class="line">serviceentries.networking.istio.io         2023-08-24T05:12:04Z</span><br><span class="line">sidecars.networking.istio.io               2023-08-24T05:12:04Z</span><br><span class="line">telemetries.telemetry.istio.io             2023-08-24T05:12:04Z</span><br><span class="line">virtualservices.networking.istio.io        2023-08-24T05:12:04Z</span><br><span class="line">wasmplugins.extensions.istio.io            2023-08-24T05:12:05Z</span><br><span class="line">workloadentries.networking.istio.io        2023-08-24T05:12:05Z</span><br><span class="line">workloadgroups.networking.istio.io         2023-08-24T05:12:05Z</span><br></pre></td></tr></table></figure>
<p>这些就是 istio 需要用到的 CRD 了，比较常见的比如：</p>
<ul>
<li><code>gateways</code></li>
<li><code>virtualservices</code></li>
<li><code>destinationrules</code></li>
</ul>
<h6 id="部署-bookinfo-应用"><a href="#部署-bookinfo-应用" class="headerlink" title="部署 bookinfo 应用"></a>部署 bookinfo 应用</h6><p>官方提供了 <code>bookinfo</code> 应用来演示 <code>Istio</code> 相关功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span><br><span class="line"></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br></pre></td></tr></table></figure>

<p><strong>部署应用</strong><br>在 <code>k8s-istio</code> 命名空间创建了应用对应的 <code>service</code> 和 <code>deployment</code>。服务启动需要一定时间，可通过以下命令进行查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services</span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.106.81.196   &lt;none&gt;        9080/TCP   54m</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    19h</span><br><span class="line">productpage   ClusterIP   10.103.139.13   &lt;none&gt;        9080/TCP   54m</span><br><span class="line">ratings       ClusterIP   10.102.135.80   &lt;none&gt;        9080/TCP   54m</span><br><span class="line">reviews       ClusterIP   10.103.83.28    &lt;none&gt;        9080/TCP   54m</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                              READY   STATUS              RESTARTS   AGE</span><br><span class="line">details-v1-698b5d8c98-p5kwm       0/1     ContainerCreating   0          37s</span><br><span class="line">productpage-v1-75875cf969-frn4z   0/1     ContainerCreating   0          35s</span><br><span class="line">ratings-v1-5967f59c58-zbldg       0/1     ContainerCreating   0          36s</span><br><span class="line">reviews-v1-9c6bb6658-kztz7        0/1     ContainerCreating   0          36s</span><br><span class="line">reviews-v2-8454bb78d8-jzghc       0/1     ContainerCreating   0          36s</span><br><span class="line">reviews-v3-6dc9897554-qvn7g       0/1     ContainerCreating   0          36s</span><br></pre></td></tr></table></figure>
<p>等 <code>pod</code> 都启动后，通过以下命令测试应用是否正常启动了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> <span class="string">&quot;<span class="subst">$(kubectl get pod -l app=ratings -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;)</span>&quot;</span> -c ratings -- curl -s productpage:9080/productpage | grep -o <span class="string">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<p>输出以下内容就算成功:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Simple Bookstore App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>部署网关</strong><br>此时，BookInfo 应用已经部署，但还不能被外界访问。需要借助网关才行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gateway.networking.istio.io/bookinfo-gateway created</span><br><span class="line">virtualservice.networking.istio.io/bookinfo created</span><br></pre></td></tr></table></figure>
<p>可以看到， 这里部署了一个网关（<code>gateway</code>）和一个虚拟服务（<code>virtualservice</code>）。此时在浏览器中，输入<code>http://localhost/productpage</code>应该可以访问到具体页面了。<br>确保配置文件没有问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl analyze</span><br><span class="line">✔ No validation issues found when analyzing namespace: default.</span><br></pre></td></tr></table></figure>
<p>确定ingress的ip和端口，外部访问则需要通过 <code>NodePort</code> 访问:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n  istio-system get svc istio-ingressgateway</span><br><span class="line">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.108.211.196   &lt;pending&gt;     15021:31160/TCP,80:32096/TCP,443:30055/TCP,31400:31682/TCP,15443:30083/TCP   22m</span><br></pre></td></tr></table></figure>
<p>可以看到，80 端口对应的 <code>NodePort</code> 为 32096,那么直接访问的 <code>URL</code> 就是：<code>http://$IP:32096/productpage</code>。</p>
<p>在新的终端窗口中运行此命令以启动一个 Minikube 隧道，将流量发送到 Istio Ingress Gateway。 这将为 service&#x2F;istio-ingressgateway 提供一个外部负载均衡器 EXTERNAL-IP。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ minikube tunnel</span><br><span class="line"></span><br><span class="line">Status:	</span><br><span class="line">	machine: minikube</span><br><span class="line">	pid: 1462709</span><br><span class="line">	route: 10.96.0.0/12 -&gt; 192.168.49.2</span><br><span class="line">	minikube: Running</span><br><span class="line">	services: [istio-ingressgateway]</span><br><span class="line">    errors: </span><br><span class="line">		minikube: no errors</span><br><span class="line">		router: no errors</span><br><span class="line">		loadbalancer emulator: no errors</span><br></pre></td></tr></table></figure>
<p>设置入站主机和端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span class="string">&#x27;&#123;.status.loadBalancer.ingress[0].ip&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">export</span> INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[?(@.name==&quot;http2&quot;)].port&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">export</span> SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[?(@.name==&quot;https&quot;)].port&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>设置环境变量 GATEWAY_URL：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> GATEWAY_URL=<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span><br></pre></td></tr></table></figure>
<p>确保 IP 地址和端口均成功地赋值给了环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$GATEWAY_URL</span>&quot;</span></span><br><span class="line">192.168.99.100:32194</span><br></pre></td></tr></table></figure>
<p>用浏览器查看 Bookinfo 应用的产品页面，验证 Bookinfo 已经实现了外部访问。</p>
<h6 id="查看仪表盘（Dashboard）"><a href="#查看仪表盘（Dashboard）" class="headerlink" title="查看仪表盘（Dashboard）"></a>查看仪表盘（Dashboard）</h6><p><code>Istio</code> 也提供了 <code>Dashboard</code>，可以通过UI 界面更加方便的进行管理，安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f samples/addons</span><br></pre></td></tr></table></figure>
<p>等待安装完成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment/kiali -n istio-system</span><br><span class="line">...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;kiali&quot;</span> rollout to finish: 0 of 1 updated replicas are available..</span><br><span class="line">kubectl rollout status deployment/kiali -n istio-system.</span><br></pre></td></tr></table></figure>

<p>访问 bashboard：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Kiali 和其他插件，等待部署完成。</span></span><br><span class="line">$ kubectl apply -f samples/addons</span><br><span class="line">$ kubectl rollout status deployment/kiali -n istio-system</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;kiali&quot;</span> rollout to finish: 0 of 1 updated replicas are available...</span><br><span class="line">deployment <span class="string">&quot;kiali&quot;</span> successfully rolled out</span><br><span class="line"><span class="comment"># 访问 Kiali 仪表板。</span></span><br><span class="line">$ istioctl dashboard kiali</span><br></pre></td></tr></table></figure>
<p>外部访问则把 <code>service</code> 改成 <code>nodeport</code> 类型即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n istio-system  patch svc kiali -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>查看修改后的端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n istio-system get svc kiali</span><br><span class="line">NAME    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">kiali   NodePort   10.101.47.41   &lt;none&gt;        20001:31989/TCP,9090:32136/TCP   4m14s</span><br></pre></td></tr></table></figure>
<p>访问 <code>http://$IP:31989</code> 即可，在主界面可以看到部署的服务以及请求量、资源使用量等情况。在 <code>Graph</code> 界面则能够看到，服务间流量分发情况。由于之前部署的 <code>bookinfo</code> 服务没怎么访问，所以界面是空白的，先通过 <code>curl</code> 命令访问一下。在左侧的导航菜单，选择 Graph ，然后在 Namespace 下拉列表中，选择 istio-system 。</p>
<blockquote>
<p><strong>要查看追踪数据，必须向服务发送请求。请求的数量取决于 Istio 的采样率。 采样率在安装 <code>Istio</code> 时设置，默认采样速率为 1%。在第一个跟踪可见之前，您需要发送至少 100 个请求。 使用以下命令向 <code>productpage</code> 服务发送 100 个请求：</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 1 100`; <span class="keyword">do</span> curl -s -o /dev/null http://<span class="variable">$GATEWAY_URL</span>/productpage; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><code>Kiali</code> 仪表板展示了网格的概览以及 <code>Bookinfo</code> 示例应用的各个服务之间的关系。 它还提供过滤器来可视化流量的流动。</p>
<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_21.png" class="">

<h6 id="卸载-Istio"><a href="#卸载-Istio" class="headerlink" title="卸载 Istio"></a>卸载 Istio</h6><p>以下命令卸载 Istio 并删除所有相关资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f samples/addons</span><br><span class="line">$ istioctl x uninstall --purge -y</span><br></pre></td></tr></table></figure>
<p>删除 <code>namespace</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete namespace k8s-istio</span><br></pre></td></tr></table></figure>
<p>移除之前打的 <code>label</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label namespace default istio-injection-</span><br></pre></td></tr></table></figure>
<p>到这里，Istio 的安装就结束了，后续就可以用起来了。</p>
<h5 id="Istio-遥测（Telemetry）"><a href="#Istio-遥测（Telemetry）" class="headerlink" title="Istio 遥测（Telemetry）"></a>Istio 遥测（Telemetry）</h5><p><code>Istio</code> 服务网格最受欢迎和最强大的功能之一是其高级可观察性。由于所有服务到服务的通信都是通过 <code>Envoy</code> 代理进行路由，并且 <code>Istio</code> 的控制平面能够从这些代理收集日志和指标，因此服务网格可以为我们提供有关网络状态和服务行为的数据。这为运营商提供了独特的故障排除、管理和优化服务的方法，而不会给应用程序开发人员带来任何额外的负担。</p>
<h6 id="Istio-遥测指标"><a href="#Istio-遥测指标" class="headerlink" title="Istio 遥测指标"></a>Istio 遥测指标</h6><ul>
<li><p>代理级别指标<br>代理级别指标是 <code>Envoy</code> 代理本身提供的有关所有直通流量的标准指标，以及有关代理管理功能的详细统计信息，包括配置和运行状况信息。Envoy 生成的指标存在于 Envoy 资源（例如监听器和集群）的粒度级别。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># TYPE envoy_cluster_internal_upstream_rq_200 counter</span><br><span class="line">envoy_cluster_internal_upstream_rq_200<span class="punctuation">&#123;</span>cluster_name=<span class="string">&quot;xds-grpc&quot;</span><span class="punctuation">&#125;</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># TYPE envoy_cluster_upstream_rq_200 counter</span><br><span class="line">envoy_cluster_upstream_rq_200<span class="punctuation">&#123;</span>cluster_name=<span class="string">&quot;xds-grpc&quot;</span><span class="punctuation">&#125;</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># TYPE envoy_cluster_upstream_rq_completed counter</span><br><span class="line">envoy_cluster_upstream_rq_completed<span class="punctuation">&#123;</span>cluster_name=<span class="string">&quot;xds-grpc&quot;</span><span class="punctuation">&#125;</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"># TYPE envoy_cluster_internal_upstream_rq_503 counter</span><br><span class="line">envoy_cluster_internal_upstream_rq_503<span class="punctuation">&#123;</span>cluster_name=<span class="string">&quot;xds-grpc&quot;</span><span class="punctuation">&#125;</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># TYPE envoy_cluster_upstream_cx_rx_bytes_total counter</span><br><span class="line">envoy_cluster_upstream_cx_rx_bytes_total<span class="punctuation">&#123;</span>cluster_name=<span class="string">&quot;xds-grpc&quot;</span><span class="punctuation">&#125;</span> <span class="number">2056154</span></span><br><span class="line"></span><br><span class="line"># TYPE envoy_server_memory_allocated gauge</span><br><span class="line">envoy_server_memory_allocated<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> <span class="number">15853480</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务级别指标<br>除了代理级别的指标之外，<code>Istio</code> 还提供了一组面向服务的指标来监控服务通信。这些指标涵盖了四种基本服务监控需求：延迟、流量、错误和饱和度。<code>Istio</code> 附带了一组默认的仪表板，用于根据这些指标监控服务行为。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># TYPE istio_requests_total counter</span><br><span class="line">istio_requests_total<span class="punctuation">&#123;</span></span><br><span class="line">    connection_security_policy=<span class="string">&quot;mutual_tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_app=<span class="string">&quot;analytics&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_principal=<span class="string">&quot;cluster.local/ns/backyards-demo/sa/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_service=<span class="string">&quot;analytics.backyards-demo.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_service_name=<span class="string">&quot;analytics&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_service_namespace=<span class="string">&quot;backyards-demo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_version=<span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_workload=<span class="string">&quot;analytics-v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    destination_workload_namespace=<span class="string">&quot;backyards-demo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    permissive_response_code=<span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">    permissive_response_policyid=<span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">    reporter=<span class="string">&quot;destination&quot;</span><span class="punctuation">,</span></span><br><span class="line">    request_protocol=<span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    response_code=<span class="string">&quot;200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    response_flags=<span class="string">&quot;-&quot;</span><span class="punctuation">,</span></span><br><span class="line">    source_app=<span class="string">&quot;bookings&quot;</span><span class="punctuation">,</span></span><br><span class="line">    source_principal=<span class="string">&quot;cluster.local/ns/backyards-demo/sa/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    source_version=<span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    source_workload=<span class="string">&quot;bookings-v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    source_workload_namespace=<span class="string">&quot;backyards-demo&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="number">1855</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Istio-遥测架构-v2"><a href="#Istio-遥测架构-v2" class="headerlink" title="Istio 遥测架构 v2"></a>Istio 遥测架构 v2</h6><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_24.png" class="">
<blockquote>
<p>根据 <code>Istio</code> 文档，新的遥测系统将延迟减少了一半 - 90% 的延迟已从 7 毫秒减少到 3.3 毫秒。不仅如此，<code>Mixer</code> 的消除还使总 <code>CPU</code> 消耗减少了 50%，达到每秒每 1,000 个请求 0.55 个 <code>vCPU</code>。</p>
</blockquote>
<h6 id="WASM架构"><a href="#WASM架构" class="headerlink" title="WASM架构"></a>WASM架构</h6><p><code>WebAssembly</code>（通常缩写为 <code>WASM</code>）是一种开放标准，它定义了可执行程序的可移植二进制代码格式、相应的文本汇编语言以及促进程序与其主机环境之间交互的接口。<code>WebAssembly</code> 的主要目标是在网页上启用高性能应用程序，但该格式也设计用于在其他环境中执行和集成。它提供了一个基于精简堆栈的虚拟机，允许 <code>Web</code> 应用程序通过利用快速加载的二进制格式以接近本机的速度运行，该格式也可以转换为文本格式以进行调试。而且，虽然 <code>WebAssembly</code> 最初是作为客户端技术出现的，但在服务器端使用它有很多优点。<code>Istio</code> 社区一直在领导 <code>Envoy</code> 的 <code>WebAssembly</code> (<code>WASM</code>) 运行时的实现。该实现使用基于 <code>Google</code> 高性能<code>V8</code> 引擎构建的 <code>WebAssembly</code> 运行时。借助 Envoy 的 <code>WebAssembly</code> 插件，开发人员可以编写自定义代码，将其编译为 <code>WebAssembly</code> 插件，并配置 <code>Envoy</code> 来执行它。</p>
<p><code>Telemetry V2</code> 中的代理内服务级别指标由两个自定义插件提供，</p>
<ul>
<li><p><code>metadata-exchange</code>：必须解决的第一个问题是如何在代理中提供有关连接两端的客户端&#x2F;服务器元数据。对于基于 <code>HTTP</code> 的流量，这是通过包含对方元数据属性的请求&#x2F;响应中的自定义 <code>HTTP</code> 标头 (<code>envoy.wasm.metadata_exchange.upstream、envoy.wasm.metadata_exchange.downstream</code>) 来完成的。对于通用 <code>TCP</code> 流量，元数据交换使用基于 <code>ALPN</code> 的隧道和基于前缀的协议。定义了一个新协议<code>istio-peer-exchange</code>，该协议由网格中的客户端和服务器 <code>sidecar</code> 进行通告和优先级排序。<code>ALPN</code> 协商将协议解析为 <code>istio-peer-exchange</code>，用于启用 <code>Istio</code> 的代理之间的连接，但不解析启用 <code>Istio</code> 的代理和任何客户端之间的连接。</p>
</li>
<li><p><code>stats</code>：<code>stats</code> 插件将传入和传出的流量指标记录到 <code>Envoy</code> 统计子系统中，并可供 <code>Prometheus</code> 抓取。以下是服务级别指标的默认标签。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">eporter<span class="punctuation">:</span> conditional((context.reporter.kind | <span class="string">&quot;inbound&quot;</span>) == <span class="string">&quot;outbound&quot;</span><span class="punctuation">,</span> <span class="string">&quot;source&quot;</span><span class="punctuation">,</span> <span class="string">&quot;destination&quot;</span>)</span><br><span class="line">source_workload<span class="punctuation">:</span> source.workload.name | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">source_workload_namespace<span class="punctuation">:</span> source.workload.namespace | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">source_principal<span class="punctuation">:</span> source.principal | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">source_app<span class="punctuation">:</span> source.labels<span class="punctuation">[</span><span class="string">&quot;app&quot;</span><span class="punctuation">]</span> | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">source_version<span class="punctuation">:</span> source.labels<span class="punctuation">[</span><span class="string">&quot;version&quot;</span><span class="punctuation">]</span> | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_workload<span class="punctuation">:</span> destination.workload.name | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_workload_namespace<span class="punctuation">:</span> destination.workload.namespace | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_principal<span class="punctuation">:</span> destination.principal | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_app<span class="punctuation">:</span> destination.labels<span class="punctuation">[</span><span class="string">&quot;app&quot;</span><span class="punctuation">]</span> | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_version<span class="punctuation">:</span> destination.labels<span class="punctuation">[</span><span class="string">&quot;version&quot;</span><span class="punctuation">]</span> | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_service<span class="punctuation">:</span> destination.service.host | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_service_name<span class="punctuation">:</span> destination.service.name | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">destination_service_namespace<span class="punctuation">:</span> destination.service.namespace | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">request_protocol<span class="punctuation">:</span> api.protocol | context.protocol | <span class="string">&quot;unknown&quot;</span></span><br><span class="line">response_code<span class="punctuation">:</span> response.code | <span class="number">200</span></span><br><span class="line">connection_security_policy<span class="punctuation">:</span> conditional((context.reporter.kind | <span class="string">&quot;inbound&quot;</span>) == <span class="string">&quot;outbound&quot;</span><span class="punctuation">,</span> <span class="string">&quot;unknown&quot;</span><span class="punctuation">,</span> conditional(connection.mtls | <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="string">&quot;mutual_tls&quot;</span><span class="punctuation">,</span> <span class="string">&quot;none&quot;</span>))</span><br><span class="line">response_flags<span class="punctuation">:</span> context.proxy_error_code | <span class="string">&quot;-&quot;</span></span><br><span class="line">source_canonical_service</span><br><span class="line">source_canonical_revision</span><br><span class="line">destination_canonical_service</span><br><span class="line">destination_canonical_revision</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Istio-的安全机制"><a href="#Istio-的安全机制" class="headerlink" title="Istio 的安全机制"></a>Istio 的安全机制</h6><ul>
<li>透明的安全层</li>
<li><code>CA</code>：秘钥和证书管理</li>
<li><code>API Server</code>：认证、授权策略分发</li>
<li><code>Envoy</code>：服务间安全通信（认证、加密）</li>
</ul>
<h5 id="Envoy-架构"><a href="#Envoy-架构" class="headerlink" title="Envoy 架构"></a>Envoy 架构</h5><h6 id="Envoy-流量五元组"><a href="#Envoy-流量五元组" class="headerlink" title="Envoy 流量五元组"></a>Envoy 流量五元组</h6><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_25.png" class="">

<h6 id="Envoy-调试关键字段（RESPONSE-FLAG）"><a href="#Envoy-调试关键字段（RESPONSE-FLAG）" class="headerlink" title="Envoy 调试关键字段（RESPONSE_FLAG）"></a>Envoy 调试关键字段（RESPONSE_FLAG）</h6><ul>
<li><code>UH：upstream_cluster</code> 中没有监控的<code>host</code>, 503</li>
<li><code>UF: upstream</code> 连接失败， 503</li>
<li><code>UO: upstream_overflow</code> (熔断)</li>
<li><code>NR:</code> 没有路由配置，404</li>
<li><code>URX:</code> 请求被拒绝因为限流或超过最大连接次数</li>
<li>… …</li>
</ul>
<h5 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h5><ul>
<li><p>分析和监控应用的监控方法</p>
</li>
<li><p>查找故障点，分析性能问题</p>
</li>
<li><p>观测请求范围内的信息</p>
</li>
<li><p>起源于<code>Google的Dapper</code></p>
</li>
<li><p><code>OpenTracing: API</code> 规范、框架、库的组合</p>
</li>
<li><p><code>Span</code>: 逻辑单元；有操作名、执行时间；嵌套、有序、因果关系</p>
</li>
<li><p><code>Trace</code>：数据&#x2F;执行路径；<code>Span</code>的组合</p>
<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_26.png" class=""></li>
</ul>
<h6 id="Jaejer-组件"><a href="#Jaejer-组件" class="headerlink" title="Jaejer 组件"></a>Jaejer 组件</h6><p><a target="_blank" rel="noopener" href="https://www.jaegertracing.io/">分布式追踪框架 Jaejer</a> <code>Jaeger</code> 是<code>Uber Technologies</code>开源发布的分布式追踪平台。组件包括：</p>
<ul>
<li><code>Tracing SDKs</code>:<br>为了生成跟踪数据，必须对应用程序进行检测。受检测的应用程序在接收新请求时创建跨度，并将上下文信息（<code>trace id, span id, and baggage</code>）附加到传出请求。仅<code>ids</code>和<code>baggage</code>通过请求传播；不会传播所有其他分析数据，例如操作名称、时间、标签和日志。它会在后台异步导出到 <code>Jaeger</code> 后端。<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_27.png" class=""></li>
<li><code>Agent</code>: <blockquote>
<p><code>jaeger-agent</code>已弃用。<code>OpenTelemetry</code>数据可以直接发送到 <code>Jaeger</code> 后端，也可以使用 <code>OpenTelemetry Collector</code> 作为代理。</p>
</blockquote>
</li>
<li><code>Collector</code>: <code>jaeger-collector</code>接收跟踪的数据，通过管道处理数据以进行检验和清晰&#x2F;补全，并将跟踪的数据存储在数据库中。<code>jaeger-collector</code>内置了对多种数据库的支持,以及实现了可扩展插件框架用于自定义存储插件。</li>
<li><code>Query</code>: <code>jaeger-query</code>提供了从存储中检索跟踪的<code>API</code>，并托管用于搜索和分析跟踪的 <code>Web UI</code>。</li>
<li><code>Ingester</code>: <code>jaeger-ingester</code>是一项从 <code>Kafka</code> 读取跟踪并将其写入存储后端的服务。实际上，它是 <code>Jaeger</code> 收集器的精简版本，支持 <code>Kafka</code> 作为唯一的输入协议。</li>
</ul>
<h6 id="Jaejer-架构"><a href="#Jaejer-架构" class="headerlink" title="Jaejer 架构"></a>Jaejer 架构</h6><ul>
<li>直接存储模式<br>此部署方式，收集器从跟踪的应用程序接收数据并将其直接写入存储。存储必须能够处理平均流量和峰值流量。收集器使用内存队列来平滑短期流量峰值，但如果存储无法跟上，持续的流量峰值可能会导致数据丢失。收集器能够向 <code>SDK</code> 集中提供采样配置，称为远程采样模式。它们还可以启用自动采样配置计算，称为自适应采样。<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_28.png" class=""></li>
<li><code>Kafka</code>存储模式<br>为了防止收集器和存储之间的数据丢失，<code>Kafka</code> 可以用作中间的持久队列。需要部署一个附加组件<code>jaeger-ingester</code>来从 <code>Kafka</code> 读取数据并保存到数据库。可以部署多个<code>jaeger-ingester</code>来扩大摄取规模；他们会自动分配负载。<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_29.png" class=""></li>
<li>开放遥测模式<br><code>Jaeger Collectors</code> 可以直接从 <code>OpenTelemetry SDK</code> 接收 <code>OpenTelemetry</code> 数据。如果您已经使用 <code>OpenTelemetry Collectors</code>，例如用于收集其他类型的遥测数据或用于预处理&#x2F;丰富跟踪数据，则可以将其放置在 <code>SDK</code> 和 <code>Jaeger Collectors</code> 之间。<code>OpenTelemetry Collector</code> 可以作为应用程序边车、主机代理&#x2F;守护程序或中央集群运行。<code>OpenTelemetry Collector</code>支持<code>Jaeger</code> 的远程采样协议，可以直接从配置文件提供静态配置，也可以将请求代理到 <code>Jaeger</code> 后端（例如，当使用自适应采样时）。<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_30.png" class=""></li>
</ul>
<h5 id="项目实践"><a href="#项目实践" class="headerlink" title="项目实践"></a>项目实践</h5><h6 id="典型的CI-CD过程（DevOps）"><a href="#典型的CI-CD过程（DevOps）" class="headerlink" title="典型的CI&#x2F;CD过程（DevOps）"></a>典型的CI&#x2F;CD过程（DevOps）</h6><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_33.png" class="">
<h6 id="GitOps-持续集成-交付过程"><a href="#GitOps-持续集成-交付过程" class="headerlink" title="GitOps 持续集成&#x2F;交付过程"></a>GitOps 持续集成&#x2F;交付过程</h6><ul>
<li><code>GitOps</code>：集群管理和应用分发的持续交付方式</li>
<li>使用<code>git</code>作为信任源，保存声明式基础架构（<code>declarative infrastructure</code>）和应用程序</li>
<li>以git作为交付过程（<code>pipeline</code>）的中心</li>
<li>开发者只需通过<code>pull request</code>完成应用的部署和运维任务</li>
<li>优势：提高生产率、改进开发体验、一致性和标准化、安全<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_34.png" class=""></li>
</ul>
<h6 id="DevOps（push-pipeline）vs-GitOps（pull-pipeline）"><a href="#DevOps（push-pipeline）vs-GitOps（pull-pipeline）" class="headerlink" title="DevOps（push pipeline）vs GitOps（pull pipeline）"></a>DevOps（push pipeline）vs GitOps（pull pipeline）</h6><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_35.png" class="">

<p>优点：<code>GitOps（pull pipeline）</code>方式，部署时不用暴露安全相关的脚本操作</p>
<h6 id="Flux-介绍"><a href="#Flux-介绍" class="headerlink" title="Flux 介绍"></a>Flux 介绍</h6><p><code>Flux</code> 是一套开放、可扩展的 <code>Kubernetes</code> 持续渐进式交付解决方案。</p>
<ul>
<li>定义：<code>The GitOps operator for kubernetes</code></li>
<li>自动化部署工具（基于GitOps）</li>
<li>官方地址：<img data-src="https://fluxcd.io/" alt="Flux"></li>
<li>只需推送到 Git，Flux 就会完成剩下的工作</li>
<li>自动同步自动部署</li>
<li>声明式</li>
<li>基于代码（<code>Pull Request</code>），而不是容器<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_36.png" class=""></li>
</ul>
<h6 id="Flagger-自动化灰度发布-金丝雀部署"><a href="#Flagger-自动化灰度发布-金丝雀部署" class="headerlink" title="Flagger 自动化灰度发布(金丝雀部署)"></a>Flagger 自动化灰度发布(金丝雀部署)</h6><p><code>Flagger</code> 实现了一个控制循环，逐渐将流量转移到金丝雀，同时测量 <code>HTTP</code> 请求成功率、请求平均持续时间和 <code>Pod</code> 运行状况等关键性能指标。根据设置的阈值，金丝雀将被升级或中止，其分析将被推送到 <code>Slack</code> 通道。</p>
<ul>
<li>自动化的灰度发布工具</li>
<li>支持多种<code>Service Mesh</code>,包括(<code>istio</code>、<code>linkerd</code>、<code>app aws mesh</code>)</li>
<li>指标监控灰度发布状态</li>
<li>通知功能（接入<code>slack、microsoft term</code>）<img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_37.png" class=""></li>
</ul>
<p><code>Flagger</code>工作流程（状态流转）</p>
<ul>
<li><code>Initializing</code></li>
<li><code>Initialized</code></li>
<li><code>Progressing</code></li>
<li><code>Successed(Failed)</code><img data-src="/2023/08/22/Cloud-Native/service-mesh/service_mesh_38.png" class="">
官方地址：<a target="_blank" rel="noopener" href="https://docs.flagger.app/">Flagger</a></li>
</ul>
<h5 id="弹性设计"><a href="#弹性设计" class="headerlink" title="弹性设计"></a>弹性设计</h5><p>系统&#x2F;服务的弹性能力直接决定了它的可用性，可用性的度量是由服务级别协议（SLA - Service Level Agreement）来计算的，可用性计算公式 $Availability &#x3D; \dfrac{MTBF}{MTBF + MTTR}$。</p>
<ul>
<li>应对故障的一种方法，让系统具有容错和适应能力。</li>
<li>防止故障（<code>Fault</code>）转化为失败（<code>Failure</code>）。</li>
<li>特点：包括1.容错性：重试、幂等；伸缩性：自动水平扩展（<code>autoscaling</code>）;过载保护：超时、熔断、降级、限流；弹性测试：故障注入</li>
</ul>
<p><code>Istio</code>提供的弹性能力包括：超时、重试、熔断、故障注入。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>umbrella
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/" title="Service Mesh 架构">https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Cloud-Native/" rel="tag"># Cloud Native</a>
              <a href="/tags/service-mesh/" rel="tag"># service mesh</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/08/14/Cloud-Native/%E3%80%90Docker%E3%80%91%E6%9E%84%E5%BB%BA%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F/" rel="prev" title="【Docker】构建基础镜像">
                  <i class="fa fa-chevron-left"></i> 【Docker】构建基础镜像
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/08/29/Design-Patterns/dev-invest-ops/" rel="next" title="开发、运维、投资模式">
                  开发、运维、投资模式 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">辽ICP备15012817号-2 </a>
  </div>
  <div class="copyright">
    &copy; 2022 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">umbrella</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">609k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">33:49</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/fresh88888888" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/pjax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/search/local-search.min.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/tags/pdf.min.js"></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/fancybox.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/pace.min.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://fresh88888888.github.io/2023/08/22/Cloud-Native/service-mesh/"}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/quicklink.min.js"></script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"fresh88888888.github.io","issue_term":"title","theme":"github-light"}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.17.1/third-party/comments/utterances.min.js"></script>

</body>
</html>
