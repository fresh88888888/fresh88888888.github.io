---
title: 机器学习(ML)(二十四) — 强化学习探析
date: 2025-01-08 16:00:11
tags:
  - AI
categories:
  - 人工智能
mathjax:
  tex:
    tags: 'ams'
  svg:
    exFactor: 0.03
---

#### A2PO

**离线强化学习**旨在利用离线数据集来构建有效的**智能体策略**，而无需在线交互。这种方法需要在**行为策略**的支持下施加适当的**保守约束**，以应对分布外问题。然而，现有工作在处理来自多个**行为策略**的离线数据集时，常常面临**约束冲突**问题，即不同的**行为策略**可能在**状态空间**中表现出不一致的动作和不同的回报。为了解决这一问题，近期的**优势加权方法**优先考虑具有高优势值的样本进行**智能体**训练，但不可避免地忽视了**行为策略**的多样性。
<!-- more -->

**行为策略**(`Behavior Policy`)是**强化学习**中的一个重要概念，指的是**智能体**在与环境交互时实际采取的策略。**行为策略**(`Behavior Policy`)是**智能体**在特定状态下选择动作的规则或映射。它描述了**智能体**如何在环境中做出**决策**，并生成与环境交互所需的数据。
- **目标策略**(`Target Policy`)：是**智能体**希望学习和优化的策略，通常是期望达到最优性能的策略。
- **行为策略**(`Behavior Policy`)：与**目标策略**之间的区别在于，**行为策略**是实际执行的策略，而**目标策略**则是通过**行为策略**收集的数据来进行学习和优化的对象。

**行为策略**在**强化学习**中起着至关重要的作用，因为它直接影响到数据的多样性和质量。一个好的**行为策略**能够提供丰富的数据，使得**智能体**能够更有效地学习并优化其**目标策略**。

**优势感知策略优化**(`A2PO`)是一种新颖的**离线强化学习**方法，旨在处理混合质量数据集中的**策略优化**问题。该方法通过显式构建**优势感知策略约束**，帮助**智能体**在没有在线交互的情况下有效学习。特点：**优势感知**，`A2PO`利用**条件变分自动编码器**(`CVAE`)来解耦不同的**行为策略**，明确建模每个动作的优势值，从而优化**智能体**的决策过程；**混合质量数据集**，该方法特别设计用于处理来自多种**行为策略**的混合质量数据集，解决了传统方法在面对不一致动作和回报时可能出现的约束冲突问题；实验验证，在`D4RL`基准上进行的大量实验表明，`A2PO`在单一质量和混合质量数据集上均优于现有的其他**离线强化学习**方法，如`BCQ`、`TD3+BC`和`CQL`等。

`A2PO`适用于需要从静态数据集中学习的各种应用场景，如机器人控制、自动驾驶和游戏`AI`等。通过有效利用历史数据，该方法能够减少探索过程中的风险和成本，同时提升**智能体**的性能。`A2PO`为**离线强化学习**领域提供了一种新的思路，尤其是在处理复杂数据集时，其**优势感知机制**显著提高了**策略优化**的效果。

**离线强化学习**(`Offline Reinforcement Learning, ORL`)旨在从预先收集的数据集中学习有效的**控制策略**，而无需在线探索。这种方法在多个现实世界应用中取得了前所未有的成功，包括机器人控制和电网控制等。然而，**离线强化学习**面临着一个严峻的挑战，即**分布外**(`Out-Of-Distribution, OOD`)**问题**，这涉及到**学习策略**产生的数据与**行为策略**收集的数据之间的**分布偏移**。因此，直接在**在线强化学习**方法上应用会出现**外推误差**，即**对未见状态-动作对的错误估计**。为了解决这个`OOD`问题，**离线强化学习**方法尝试在数据集的分布范围内对**智能体**施加适当的保守约束，例如，通过正则化项限制**学习策略**，或对`OOD`动作的价值过高估计进行惩罚。**离线强化学习**在处理混合质量数据集时常常遇到约束冲突问题。具体而言，当训练数据来自多个具有不同回报的**行为策略**时，现有工作仍然平等对待每个样本约束，而没有考虑数据质量和多样性的差异。这种忽视导致对冲突动作施加不当约束，最终导致更差的结果。

**分布外**(`OOD`)：指的是在训练过程中，**智能体**所选择的**状态-动作对**不在其训练数据集的分布中。这意味着**智能体**在决策时可能会遇到未曾见过的情况，从而导致对这些**状态-动作对**的价值估计不准确。在**离线强化学习**中，**智能体**使用的是预先收集的静态数据集，而不是实时与环境交互。因此，**智能体**无法从环境中获取新的**状态-动作对**，这限制了其学习能力。当**智能体**尝试采取在训练数据集中没有出现过的动作时，就会出现`OOD`问题。这些未见过的**状态-动作对**可能会导致`Q`值或策略的高估，从而影响整体性能。

`A2PO`能够实现来自不同**行为策略**的**优势感知策略约束**，其中采用了定制的**条件变分自动编码器**(`CVAE`)来推断与**行为策略**相关的**多样化动作分布**，通过将优势值建模为条件变量。在`D4RL`基准上进行了大量实验，包括单一质量和混合质量数据集，结果表明，所提出的`A2PO`方法在性能上显著优于其他先进的**离线强化学习**基线，以及优势加权竞争者。

**离线强化学习**(`ORL`)可以大致分为四类：**策略约束**、**价值正则化**、**基于模型的方法**和**基于回报条件的监督学习**。
- **策略约束**：该方法对学习到的策略施加约束，以保持其接近**行为策略**。之前的研究直接在策略学习中引入了显式约束，例如**行为克隆**、**最大均值差异**或**最大似然估计**。相对而言，最近的努力主要集中在通过近似由`KL`-**散度约束**推导出的最优策略来隐式实现**策略约束**。
- **价值正则化**：该方法对**价值函数**施加约束，以缓解对**分布外**(`OOD`)动作的高估。研究者们尝试通过`Q-`**正则化项**来近似**价值函数**的下界，以实现保守的动作选择。
- **基于模型的方法**：该方法构建环境动态，以估计**状态-动作对**的不确定性，从而施加**分布外**(`OOD`)**惩罚**。
- **基于回报条件的监督学习任务**。**决策变换器**(`Decision Transformer，DT`)构建了一个基于当前状态和额外累积回报信号的**变换器策略**，并通过**监督学习**进行训练。`Yamagata`等人通过用`Q-Learning`结果重新标记回报信号，改善了**决策变换器**(`DT`)**策略**在次优样本上的拼接能力。然而，在混合质量数据集且无法访问轨迹回报信号的**离线强化学习**背景下，所有这些方法都平等对待每个样本，而未考虑数据质量，从而导致不当的正则化和进一步的次优学习结果。

**优势加权离线强化学习方法**通过加权采样来优先训练具有高优势值的离线数据集中的转换。为提高样本效率，`Peng`等人引入了一种**优势加权最大似然损失**，通过**轨迹回报**直接计算优势值。此外，还有研究使用**评论家网络**来估计优势值，以进行**优势加权策略训练**。这项技术已被纳入其他工作的流程当中，用于**智能体**策略提取。最近，**优势加权回归**(`AW`)方法在解决混合质量数据集中的约束冲突问题上也得到了很好的研究。一些研究提出将**优势加权行为克隆**作为直接**目标函数**或**显式策略约束**。此外，`LAPO`框架采用**优势加权损失**来训练**条件变分自编码器**(`CVAE`)，以生成基于状态条件的高优势动作。除了**优势加权回归**(`AW`)方法外，`Hong`等人增强了经典**离线强化学习**训练目标，通过后续回报的权重进行调整。而`Hong`等人则直接学习**最优策略密度**作为**权重函数**，以便从高性能策略中进行采样。然而，这种**优势加权回归**(`AW`)机制不可避免地减少了数据集中的多样性。相对而言，**优势感知策略优化**(`A2PO`)方法直接将**智能体**策略条件化于**状态**和**估计**的优势值，使得能够有效利用所有样本，无论其质量如何。

**优势加权回归**(`Advantage-Weighted Regression, AWR`)是一种简单且可扩展的**离线强化学习算法**，旨在利用标准的**监督学习**方法作为子程序。`AWR`的核心思想是通过两个**监督回归**步骤来训练**智能体**的策略和**价值函数**。原理：**价值函数回归**，首先，`AWR`通过**回归累计奖励**来训练一个**价值函数基线**。这一步骤的目的是建立一个对**环境奖励**的估计，使得后续的**策略更新**能够更好地反映出哪些动作是有效的；**策略回归**，接下来，`AWR`使用**加权回归**来更新策略。这里，**加权**是基于每个动作的**优势值**(`advantage`)，即**某个动作相对于当前策略的期望收益的提升程度**。通过这种方式，`AWR`能够优先选择那些表现更好的动作，从而提高**学习效率**。

`LAPO`(`Latent-Variable Advantage-Weighted Policy Optimization`)是一种针对**离线强化学习算法**，旨在有效处理异质性数据集中的**策略学习**问题。该方法通过利用潜在变量生成模型来表示高优势的**状态-动作对**，从而提高策略的学习效率和效果。原理：**潜在空间建模**，`LAPO`通过学习一个状态条件的潜在空间，生成高优势动作样本。这种方法使得**智能体**能够选择那些在训练数据中支持的动作，同时有效地解决目标任务；**优势加权**，该算法采用**优势加权策略**，通过**最大化加权对数似然**来学习高回报动作。具体来说，`LAPO`通过两步交替进行：估计每个动作的重要性权重，并根据这些权重回归数据集中的动作；`Q`**函数优化**，`LAPO`在每次迭代中优化潜在策略，以直接最大化回报。它使用标准**强化学习**方法（如`DDPG`或`TD3`）来更新潜在动作，这些动作经过**解码器**转换为**原始动作空间**。

我们将**强化学习**(`RL`)任务形式化为一个**马尔可夫决策过程**(`MDP`)，定义为一个**元组**{% mathjax %}\mathcal{M} = \langle \mathcal{S},\mathcal{A},P,r,\gamma,p_0 \rangle{% endmathjax %}，其中{% mathjax %}\mathcal{S}{% endmathjax %}表示**状态空间**，{% mathjax %}\mathcal{A}{% endmathjax %}表示动作空间，{% mathjax %}P\;:\;\mathcal{S}\times\mathcal{A}\times\mathcal{S}\rightarrow [0,1]{% endmathjax %}表示**环境动态**，{% mathjax %}r\;:\;\mathcal{S}\times\mathcal{A}\rightarrow \mathbb{R}{% endmathjax %}表示**奖励函数**，{% mathjax %}\gamma\in(0,1]{% endmathjax %}是**折扣因子**，{% mathjax %}p_0{% endmathjax %}是**初始状态分布**。在每个时间步{% mathjax %}t{% endmathjax %}，**智能体**观察状态{% mathjax %}s\in \mathcal{S}{% endmathjax %}，并根据其策略{% mathjax %}\pi{% endmathjax %}选择一个动作{% mathjax %}a_t\in\mathcal{A}{% endmathjax %}。这个动作导致根据动态分布{% mathjax %}P{% endmathjax %}转移到下一个状态
{% mathjax %}s_{t+1}{% endmathjax %}。此外，**智能体**还会收到奖**励信号**{% mathjax %}r_t{% endmathjax %}。**强化学习**的目标是学习一个**最优策略**{% mathjax %}\pi^*{% endmathjax %}，以最大化期望回报：{% mathjax %}\pi^* = \text{arg }\max_{\pi}\;\mathbb{E}_{\pi}\bigg[\sum\limits_{k=0}^{\infty} \gamma^k r_{t+k}\bigg]{% endmathjax %}。在**离线强化学习**中，**智能体**只能从离线数据集中学习，而无法与环境进行在线交互。在单一质量设置中，离线数据集{% mathjax %}\mathcal{D} = \{(s_t,a_t,r_t,s_{t+1})|t=1,\ldots,N\}{% endmathjax %}是由单一行为策略{% mathjax %}\pi_{\beta}{% endmathjax %}收集的，包含{% mathjax %}N{% endmathjax %}次转换。在混合质量设置中，离线数据集{% mathjax %}\mathcal{D} = \bigcup_i\{(s_{i,t},a_{i,t},r_{i,t},s_{i,t+1})|t=1,\ldots,N\}{% endmathjax %}是由多个**行为策略**{% mathjax %}\{\pi_{\beta_i}\}_{i=1}^M{% endmathjax %}收集的。通过**动作价值函数**{% mathjax %}Q^{\pi}(s,a) = \mathbb{E}_{\pi}[\sum_{t=0}^{infty} \gamma^t r(s_t,a_t)|s_0 = s,a_0 = a]{% endmathjax %}来评估学习到的策略{% mathjax %}pi{% endmathjax %}。**状态价值函数**定义为{% mathjax %}V^{\pi}(s) = \mathbb{E}_{a\sim\pi}[Q^{\pi}(s,a)]{% endmathjax %}，而**优势函数**定义为{% mathjax %}A^{\pi}(s,a) = Q^{\pi}(s,a) - V^{\pi}(s){% endmathjax %}。对于连续控制，`A2PO`实现使用基于`actor-critic`框架的`TD3`算法作为其基础，以确保稳健的性能。**演员网络**{% mathjax %}\pi_{\omega}{% endmathjax %}，即学习到的策略，由参数{% mathjax %}\omega{% endmathjax %}参数化，而**评论家网络**则由参数为{% mathjax %}\theta{% endmathjax %}的`Q`-网络{% mathjax %}Q_{\theta}{% endmathjax %}和参数为{% mathjax %}\phi{% endmathjax %}的`V`-网络{% mathjax %}V_{\phi}{% endmathjax %}组成。`actor-critic`框架涉及两个步骤：**策略评估**和**策略改进**。在**策略评估**阶段，通过**时间差**(`TD`)**损失优化**`Q`-网络{% mathjax %}Q_{\theta}{% endmathjax %}。
{% asset_img ml_1.png "优势感知策略优化(Advantage-Aware Policy Optimization, A2PO)方法示意图" %}

{% mathjax '{"conversion":{"em":14}}' %}
\mathcal{L}_Q(\theta) = \mathbb{E}_{(s,a,r,s')\sim\mathcal{D},a'\sim\pi_{\hat{\omega}}(s')}[Q_{\theta}(s,a) - (r(s,a) + \gamma Q_{\hat{\theta}}(s',a'))]^2
{% endmathjax %}
我们将**目标网络**的参数{% mathjax %}\hat{\theta}{% endmathjax %}和{% mathjax %}\hat{\omega}{% endmathjax %}定期更新，以保持学习的稳定性，这些参数是通过在线参数{% mathjax %}\theta{% endmathjax %}和{% mathjax %}\omega{% endmathjax %}更新的。`V`-网络{% mathjax %}V_{\phi}{% endmathjax %}也可以通过类似的**时间差**(`TD`)**损失**进行优化。在连续控制中的策略改进阶段，**演员网络**{% mathjax %}\pi_{\omega}{% endmathjax %}可以通过确定性**策略梯度损失**进行优化。
{% mathjax '{"conversion":{"em":14}}' %}
\mathcal{L}_{\pi}(\omega) = \mathbb{E}_{s\sim\mathcal{D}}[-Q_{\theta}(s,\pi_{\omega}(s))]
{% endmathjax %}
{% note warning %}
**注意**，**离线强化学习**将在优化损失上施加保守约束，以应对**分布外**(`OOD`)问题。此外，最终学习到的策略{% mathjax %}\pi_{\omega}{% endmathjax %}的性能在很大程度上依赖于与**行为策略**{% mathjax %}\{\pi_{\beta_i}\}{% endmathjax %}相关的离线数据集{% mathjax %}\mathcal{D}{% endmathjax %}的质量。
{% endnote %}
