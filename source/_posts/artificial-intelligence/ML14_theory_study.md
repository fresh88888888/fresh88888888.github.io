---
title: 机器学习(ML)(十四) — 推荐系统探析
date: 2024-11-04 09:30:11
tags:
  - AI
categories:
  - 人工智能
mathjax:
  tex:
    tags: 'ams'
  svg:
    exFactor: 0.03
---

#### 排序 - 多目标模型

我们先回顾一下**推荐系统**的链路，分为召回，粗排、精排、重排。有很多条召回通道，从几亿个物品选出几千个物品，做完召回之后，要从中选出用户最感兴趣的物品，这就要用到粗排和精排，粗排会给召回的物品逐一打分，保留分数最高的几百个物品，然后使用精排模型给粗排选中的几百个物品打分但不做截断，让几百个物品全都带着精排分数进入重排，最后一步是重排，做多样性抽样，并且把相似内容打散，最终由几十个物品被选中展示给用户。
<!-- more -->

**排序**的主要依据是用户对物品的兴趣，兴趣可以反映在用户与物品的交互上，对于每个物品，系统会记录下面几个统计量：**曝光次数**(`number of impressions`)，就是一个物品被展示给多少用户，展示之后，才会有点击等行为；**点击次数**(`number of clicks`)，就是一个物品被多少用户点开；**点赞次数**(`number of likes`)、**收藏次数**(`number of collects`)、**转发次数**(`number of shares`)。点击率 = 点击次数 / 曝光次数、点赞率 = 点赞次数 / 点击次数、收藏率 = 收藏次数 / 点击次数、转发率 = 转发次数 / 点击次数。排序的依据：排序模型通过机器学习预估点击率、点赞量、收藏率、转发率等，做完预估之后，要对这些预估分数做融合（比如加权和），最后按照融合的分数对物品做排序、截断，保留分数最高的物品。

**多目标模型**：排序模型的输入是各种各样的特征，**用户特征**主要是用户`ID`和用户画像；**物品特征**主要是物品`ID`、物品画像和作者信息；**统计特征**：包括**用户统计特征**和**物品统计特征**，比如用户在过去`30`天曝光了多少物品，点击了多少物品，点赞了多少物品，比如物品在过去获得了多少次曝光、点击、点赞等等；**场景特征**：是随着用户请求传过来的，不如按当前的时间和用户所在的地点。这些信息对推荐很有用，把这些特征做融合(`concatenation`)，输入神经网咯，神经网络可以是简单的全连接网络，也可以是更复杂的结构，神经网络会输出一个向量，这个向量在输入`4`个神经网络，每个神经网络有`2-3`个全连接层和输出层的**激活函数**是`Sigmoid`，`4`个神经网络分别输出点击率、点赞率、收藏率和转发率的预估值。`4`个预估值都是实数，介于`0~1`之间，**推荐系统**排序就主要靠这4个预估值，它们反映出用户对物品的兴趣。如下图所示：
{% asset_img ml_1.png "多目标模型" %}

把模型输出的点击率、点赞率、收藏率和转发率，分别记作{% mathjax %}p_1,p_2,p_3,p_4{% endmathjax %}。它们都是模型做出的预估，做训练的时候，要让这些预估值去拟合真实的目标。把真实的目标记作{% mathjax %}y_1,y_2,y_3,y_4{% endmathjax %}，分别对应：点击、点赞、收藏和转发的行为。{% mathjax %}y{% endmathjax %}要么是0、要么是1，举个例子，{% mathjax %}y_1 = 1,y_2 = 0,y_3 = 0,y_4 = 1{% endmathjax %}，表示用户对物品有点击、没点赞、没收藏和有转发。这些是用户的真实的行为，被记录下来。用这样的数据来训练模型，训练是要鼓励模型的预测接近目标，其实就是二元分类，就是判定用户是否会点击物品，有点击、点赞、收藏和转发4个任务，每个任务都是一个二元分类，可以使用**交叉熵损失函数**。对于点击这个任务使用{% mathjax %}y_1{% endmathjax %}和{% mathjax %}p_1{% endmathjax %}的**交叉熵作为损失函数**，记作{% mathjax %}\text{CrossEntropy}(y_1,p_1) = -(y_1\ln p_1 + (1 - y_1)\ln (1 - p_1)){% endmathjax %}，{% mathjax %}p_1{% endmathjax %}越接近{% mathjax %}y_1{% endmathjax %}，那么交叉熵损失就越小。我们把4个函数的加权和作为总的损失函数，记作{% mathjax %}\sum_{i=1}^4 \alpha_i \cdot \text{CrossEntropy}(y_i,p_i){% endmathjax %}，其中权重{% mathjax %}\alpha{% endmathjax %}是根据经验设置的。在收集的历史数据上训练神经网络的参数，最小化损失函数，损失函数越小，说明模型的预测越接近真实目标。做训练的时候，把**损失函数**关于**神经网络**的参数求**梯度**，做**梯度下降**更新**神经网络**的参数。

实际的训练中会有很多困难：做训练的时候存在类别不平衡的问题，**正样本少，负样本多**。比如说每`100`次曝光，约有`10`次点击，`90`次无点击。点击的是正样本，没有点击的负样本。要太多的负样本用途不大，白白浪费计算资源。解决方案就是负样本的降采样(`down-sampling`)，只保留其中一小部分负样本，让正负样本数量保持平衡，降低训练的计算代价。给定用户特征、物品特征，用神经网络预估出点击率、点赞率等之后，就要对这些预估分数做校准，做完校准之后才能把这些预估值做排序。为什么要做校准？首先设正样本、负样本的数量为{% mathjax %}n_{+}{% endmathjax %}和{% mathjax %}n_{-}{% endmathjax %}，以点击为例，曝光之后有点击就是正样本，否则就是负样本，负样本数量通常远大于正样本，在训练的时候要对负样本做降采样，抛弃一部分负样本，这样会使正、负样本的差距不太悬殊，把采样率记作{% mathjax %}\alpha{% endmathjax %}，它介于0~1之间，使用负样本的数量等于{% mathjax %}\alpha\cdot n_{-}{% endmathjax %}，由于减少了负样本的数量，模型预估点击率大于真实点击率，{% mathjax %}\alpha{% endmathjax %}越小，负样本越少，模型对点击率高估就会越严重，把真实的点击率记作{% mathjax %}p_{\text{true}} = \frac{n_{+}}{n_{+} + n_{-}}{% endmathjax %}，样本的总数等于{% mathjax %}n_{+} + n_{-}{% endmathjax %}，预估的点击率记作{% mathjax %}p_{\text{pred}} = \frac{n_{+}}{n_{+} + \alpha\cdot n_{-}}{% endmathjax %}，把上面两个公式合起来，记作{% mathjax %}p_{\text{true}} = \frac{\alpha\cdot p_{\text{pred}}}{(1 - p_{\text{pred}}) + \alpha\cdot p_{\text{pred}}}{% endmathjax %}，这个公式就是预估点击率的校准。等式左边的{% mathjax %}p_{\text{pred}}{% endmathjax %}是校准之后的点击率，等式右边是对预估点击率{% mathjax %}p_{\text{pred}}{% endmathjax %}做的变换，公式中用到了采样率{% mathjax %}alpha{% endmathjax %}，在线上排序的时候，首先让模型预估{% mathjax %}p_{\text{pred}}{% endmathjax %}，然后使用{% mathjax %}p_{\text{true}} = \frac{\alpha\cdot p_{\text{pred}}}{(1 - p_{\text{pred}}) + \alpha\cdot p_{\text{pred}}}{% endmathjax %}做校准，最后拿校准之后的点击率作为排序的依据。

#### 召回 - MMoE

`MMoE`(`Multi-gate Mixture-of-Exports`)：模型的输入是一个向量，包含**用户特征**、**物品特征**、**统计特征**、**场景特征**。把向量输入`3`个**神经网络**，每个神经网络结构都相同，都是由很多全连接层组成，但是这`3`个神经网络不共享参数，这`3`个神经网络各输出一个向量，这`3`个向量记作{% mathjax %}x_1,x_2,x_3{% endmathjax %}，这`3`个神经网络代表`3`个”专家“。把下面的特征向量输入到另一个神经网络，这个神经网络也有多个全连层，神经网络的最后加入一个`softmax`激活函数，输出一个`3`维的向量。由于是softmax输出，向量的`3`个元素都大于`0`，而且相加等于`1`，向量的`3`个元素记作{% mathjax %}p_1,p_2,p_3{% endmathjax %}，分别对应`3`个专家神经网络，之后用这`3`个元素做权重，对向量{% mathjax %}x_1,x_2,x_3{% endmathjax %}做**加权平均**；同样的方法，把下面的特征向量送入右边的神经网络，在神经网络的最后也是`softmax`激活函数，输出一个`3`个向量，分别记作{% mathjax %}q_1,q_2,q_3{% endmathjax %}，这三个元素也是之后做加权平均的权重。如下图所示：
{% asset_img ml_2.png "MMoE模型" %}

